<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missão Agente Secreta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos Gerais */
        :root {
            --background-color: #1a233b;
            --primary-color: #2c3a5e;
            --accent-color: #f0c419;
            --text-color: #e0e0e0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --locked-color: #5a688a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--primary-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            padding: 30px;
            border: 3px solid var(--accent-color);
            overflow: hidden;
            position: relative;
        }
        
        /* Estilos das Telas */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .screen.active {
            display: flex;
        }

        h1, h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: clamp(1.8rem, 5vw, 2.5rem);
        }

        h2 {
            font-size: clamp(1.5rem, 4vw, 1.8rem);
        }

        p {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Botões */
        .btn {
            background-color: var(--accent-color);
            color: var(--background-color);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            background-color: var(--locked-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mission-btn.locked {
            background-color: var(--locked-color);
            color: #9eabc2;
            cursor: not-allowed;
        }
        
        .mission-btn.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .mission-btn.completed {
            background-color: var(--success-color);
            color: white;
        }

        /* Estilos dos Desafios */
        .challenge-container {
            width: 100%;
            background-color: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .challenge-input {
            padding: 10px;
            font-size: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--accent-color);
            background-color: var(--text-color);
            color: var(--background-color);
            text-align: center;
            width: 150px;
            margin: 10px;
        }

        /* Desafio do Calendário */
        #calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        .calendar-day, .calendar-header {
            background-color: var(--locked-color);
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .calendar-header {
            background-color: transparent;
            color: var(--accent-color);
        }
        .calendar-day:not(.empty) {
            cursor: pointer;
        }
        .calendar-day.start-day {
            background-color: var(--accent-color);
            color: var(--background-color);
        }
        .calendar-day:not(.empty):hover {
            background-color: #8a99bd;
        }

        /* Desafio das Embalagens */
        .packaging-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .packaging-item {
            background-color: #fff;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .packaging-item:hover {
            transform: scale(1.05);
        }

        /* Desafio das Formas */
        .shape-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .shape-btn {
            width: 80px;
            height: 80px;
            background-color: var(--locked-color);
            border: 3px solid var(--accent-color);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .shape-btn:hover {
            background-color: #8a99bd;
        }
        .shape-btn.square { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" fill="%23f0c419"/></svg>'); }
        .shape-btn.circle { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23f0c419"/></svg>'); }
        .shape-btn.triangle { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,10 90,90 10,90" fill="%23f0c419"/></svg>'); }
        .shape-btn.rectangle { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="10" y="25" width="80" height="50" fill="%23f0c419"/></svg>'); }
        
        .spatial-shape-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .spatial-shape-item {
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .spatial-shape-item:hover {
            background-color: var(--locked-color);
        }
        .spatial-shape-item svg {
            width: 100px;
            height: 100px;
        }

        /* Relatório */
        #report-content {
            text-align: left;
            width: 100%;
        }
        .report-section {
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .report-section h3 {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .report-item {
            margin-bottom: 5px;
        }
        .highlight {
            color: var(--success-color);
            font-weight: bold;
        }
        .to-train {
            color: var(--error-color);
            font-weight: bold;
        }

        /* Modal de Feedback */
        #feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            padding: 40px;
            background-color: var(--primary-color);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 3px solid;
        }
        .modal-content.success {
            border-color: var(--success-color);
        }
        .modal-content.error {
            border-color: var(--error-color);
        }
        .modal-content h3 {
            font-size: 2rem;
            margin: 0;
        }

        /* Ícones SVG */
        .icon {
            width: 24px;
            height: 24px;
        }

        /* Rodapé */
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            color: var(--locked-color);
        }
        footer a {
            color: var(--accent-color);
            text-decoration: none;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- TELA DE LOGIN -->
        <div id="login-screen" class="screen active">
            <h1><svg class="icon" style="width:40px; height:40px; display:inline-block; vertical-align: -5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> Missão Agente Secreta</h1>
            <p>Digite o nome do agente para iniciar a missão!</p>
            <input type="text" id="player-name-input" class="challenge-input" placeholder="Nome do Agente" style="width: 250px;">
            <button id="start-game-btn" class="btn" disabled>Iniciar Missão</button>
            <footer>
                <p>Desenvolvido por: Alexandre Kulpel</p>
                <p>Contato: <a href="mailto:alexandrekulpel@gmail.com">alexandrekulpel@gmail.com</a></p>
            </footer>
        </div>

        <!-- TELA DE MISSÕES -->
        <div id="missions-screen" class="screen">
            <h2 id="missions-header">Quartel-General</h2>
            <p>Selecione sua próxima missão para deter o Dr. Desordem!</p>
            <div id="missions-container">
                <button id="mission-1-btn" class="mission-btn btn" data-mission="1">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    Missão 1: O Cronograma Secreto
                </button>
                <button id="mission-2-btn" class="mission-btn btn" data-mission="2">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Missão 2: Contabilizando as Provas
                </button>
                <button id="mission-3-btn" class="mission-btn btn" data-mission="3">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path></svg>
                    Missão 3: O Cofre Geométrico
                </button>
            </div>
        </div>

        <!-- TELA DE CONTEÚDO DA MISSÃO -->
        <div id="mission-content-screen" class="screen">
            <h2 id="mission-title"></h2>
            <p id="mission-instruction"></p>
            <div id="challenge-area" class="challenge-container">
                <!-- O conteúdo do desafio será injetado aqui -->
            </div>
            <button id="back-to-missions-btn" class="btn" style="background-color: var(--locked-color); margin-top: 20px;">Voltar para Missões</button>
        </div>

        <!-- TELA DE FIM DE JOGO -->
        <div id="game-over-screen" class="screen">
            <h2>Missão Cumprida!</h2>
            <p id="game-over-message"></p>
            <button id="show-report-btn" class="btn">Ver Relatório de Desempenho</button>
            <button id="play-again-btn" class="btn" style="background-color: var(--success-color);">Jogar Novamente</button>
        </div>

        <!-- TELA DE RELATÓRIO -->
        <div id="report-screen" class="screen">
            <h2 id="report-header">Relatório de Desempenho</h2>
            <p id="report-subheader">Análise de progresso do agente.</p>
            <div id="report-content"></div>
            <button id="back-to-start-btn" class="btn" style="background-color: var(--locked-color); margin-top: 20px;">Voltar ao Início</button>
        </div>
    </div>

    <!-- MODAL DE FEEDBACK -->
    <div id="feedback-modal">
        <div id="modal-content-box" class="modal-content">
            <h3 id="feedback-message"></h3>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Elementos da UI
        const screens = document.querySelectorAll('.screen');
        const feedbackModal = document.getElementById('feedback-modal');
        const modalContentBox = document.getElementById('modal-content-box');
        const feedbackMessage = document.getElementById('feedback-message');
        const playerNameInput = document.getElementById('player-name-input');
        const missionsHeader = document.getElementById('missions-header');
        const gameOverMessage = document.getElementById('game-over-message');
        const reportHeader = document.getElementById('report-header');
        const reportSubheader = document.getElementById('report-subheader');

        // Botões
        const startGameBtn = document.getElementById('start-game-btn');
        const backToMissionsBtn = document.getElementById('back-to-missions-btn');
        const missionBtns = document.querySelectorAll('.mission-btn');
        const showReportBtn = document.getElementById('show-report-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const backToStartBtn = document.getElementById('back-to-start-btn');

        // Dados do Jogo
        let gameData;
        let playerName = '';

        // Função para inicializar/resetar os dados do jogo
        function initializeGameData() {
            gameData = {
                missions: {
                    1: { completed: false, challenges: { 1: { attempts: 0, success: 0 }, 2: { attempts: 0, success: 0 }, 3: { attempts: 0, success: 0 } } },
                    2: { completed: false, challenges: { 1: { attempts: 0, success: 0 }, 2: { attempts: 0, success: 0 }, 3: { attempts: 0, success: 0 } } },
                    3: { completed: false, challenges: { 1: { attempts: 0, success: 0 }, 2: { attempts: 0, success: 0 } } }
                }
            };
        }

        // Função para navegar entre as telas
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Função para mostrar feedback (modal)
        function showFeedback(message, isSuccess) {
            feedbackMessage.textContent = message;
            modalContentBox.className = 'modal-content';
            modalContentBox.classList.add(isSuccess ? 'success' : 'error');
            feedbackModal.style.display = 'flex';

            setTimeout(() => {
                feedbackModal.style.display = 'none';
            }, 1500);
        }

        // Atualiza o estado dos botões de missão
        function updateMissionButtons() {
            missionBtns.forEach(btn => {
                const missionId = btn.dataset.mission;
                btn.classList.remove('completed', 'locked');
                if (gameData.missions[missionId].completed) {
                    btn.classList.add('completed');
                } else {
                    if (missionId == 2 && !gameData.missions[1].completed) {
                        btn.classList.add('locked');
                    } else if (missionId == 3 && !gameData.missions[2].completed) {
                        btn.classList.add('locked');
                    }
                }
            });
        }
        
        // Verifica se uma missão foi concluída
        function checkMissionCompletion(missionId) {
            const mission = gameData.missions[missionId];
            const challenges = Object.values(mission.challenges);
            const allChallengesDone = challenges.every(c => c.success > 0);
            if (allChallengesDone) {
                mission.completed = true;
            }
        }

        // Verifica se o jogo terminou
        function checkGameOver() {
            const allMissions = Object.values(gameData.missions);
            const allMissionsCompleted = allMissions.every(m => m.completed);
            if (allMissionsCompleted) {
                gameOverMessage.textContent = `Parabéns, Agente ${playerName}! Você deteve o Dr. Desordem e recuperou os itens secretos.`;
                showScreen('game-over-screen');
            }
        }

        // Registra uma tentativa em um desafio
        function recordAttempt(missionId, challengeId, isSuccess) {
            const challenge = gameData.missions[missionId].challenges[challengeId];
            
            // Para o relatório, só registra o resultado da primeira tentativa.
            if (challenge.attempts === 0) {
                 challenge.attempts++;
                 if (isSuccess) {
                    challenge.success = 1;
                 }
            }
            
            if (isSuccess) {
                // Para a progressão, marca como sucesso na primeira resposta correta, mesmo que não seja a primeira tentativa.
                if (challenge.success === 0) {
                    challenge.success = 1;
                }
                showFeedback('Incrível, Agente!', true);
                checkMissionCompletion(missionId);
                updateMissionButtons();
            } else {
                showFeedback('Tente de novo, agente!', false);
            }
        }

        // --- Funções para gerar problemas dinâmicos ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function generateCalendarProblem() {
            const startDay = getRandomInt(1, 15);
            const weeks = getRandomInt(1, 2);
            const days = getRandomInt(1, 6);
            const answer = startDay + (weeks * 7) + days;
            const text = `o Dr. Desordem planeja agir ${weeks} semana(s) e ${days} dia(s) depois do dia ${startDay} de maio.`;
            return { startDay, answer, text };
        }

        function numberToWords(num) {
            const ones = ['', 'uma', 'duas', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove'];
            const teens = ['dez', 'onze', 'doze', 'treze', 'catorze', 'quinze', 'dezesseis', 'dezessete', 'dezoito', 'dezenove'];
            const tens = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta'];
            if (num === 0) return 'zero';
            if (num < 10) return ones[num];
            if (num < 20) return teens[num - 10];
            const ten = Math.floor(num / 10);
            const one = num % 10;
            return tens[ten] + (one > 0 ? ' e ' + ones[one] : '');
        }

        function generateClockProblem() {
            const hour = getRandomInt(0, 23);
            const minute = getRandomInt(0, 59);
            const hourText = numberToWords(hour);
            const minuteText = minute > 0 ? numberToWords(minute) : '';
            let text = `O alarme tocará às '${hourText} hora(s)${minute > 0 ? ` e ${minuteText} minutos` : ''}'.`;
            if (hour === 1) text = text.replace('hora(s)', 'hora');
            return { hour, minute, text };
        }
        
        function generateAdditionProblem() {
            let num1, num2;
            do {
                num1 = getRandomInt(11, 89);
                num2 = getRandomInt(11, 89);
            } while ((num1 % 10) + (num2 % 10) < 10);
            return { num1, num2, answer: num1 + num2 };
        }

        function generateSubtractionProblem() {
            let num1, num2;
            do {
                num1 = getRandomInt(50, 99);
                num2 = getRandomInt(11, 49);
            } while ((num1 % 10) >= (num2 % 10));
            return { num1, num2, answer: num1 - num2 };
        }
        
        // --- Lógica das Missões ---
        const missions = {
            1: {
                title: "Missão 1: O Cronograma Secreto",
                challenges: [
                    { 
                        instruction: "Agente, decifre a pista do cronograma:",
                        render: (container) => {
                            const problem = generateCalendarProblem();
                            container.parentElement.querySelector('#mission-instruction').textContent = `Agente, ${problem.text} Descubra a data exata.`;
                            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                            const calendar = document.createElement('div');
                            calendar.id = 'calendar';
                            daysOfWeek.forEach(day => {
                                const header = document.createElement('div');
                                header.className = 'calendar-header';
                                header.textContent = day;
                                calendar.appendChild(header);
                            });
                            const firstDayOfMonth = 4;
                            for(let i = 0; i < firstDayOfMonth; i++) {
                                const empty = document.createElement('div');
                                empty.className = 'calendar-day empty';
                                calendar.appendChild(empty);
                            }
                            for(let day = 1; day <= 31; day++) {
                                const dayEl = document.createElement('div');
                                dayEl.className = 'calendar-day';
                                dayEl.textContent = day;
                                dayEl.dataset.day = day;
                                if (day === problem.startDay) dayEl.classList.add('start-day');
                                dayEl.addEventListener('click', () => {
                                    const isCorrect = day === problem.answer;
                                    recordAttempt(1, 1, isCorrect);
                                    if(isCorrect) {
                                       setTimeout(() => startMission(1, 1), 1600);
                                    }
                                });
                                calendar.appendChild(dayEl);
                            }
                            container.innerHTML = '';
                            container.appendChild(calendar);
                        }
                    },
                    { 
                        instruction: "Ajuste o relógio digital para a hora correta para desativá-lo!",
                        render: (container) => {
                            const problem = generateClockProblem();
                            container.parentElement.querySelector('#mission-instruction').textContent = problem.text;
                            container.innerHTML = `
                                <input type="number" id="hours-input" class="challenge-input" min="0" max="23" placeholder="HH">
                                <span>:</span>
                                <input type="number" id="minutes-input" class="challenge-input" min="0" max="59" placeholder="MM">
                                <br>
                                <button id="check-time-btn" class="btn">Verificar</button>
                            `;
                            document.getElementById('check-time-btn').addEventListener('click', () => {
                                const hours = document.getElementById('hours-input').value;
                                const minutes = document.getElementById('minutes-input').value;
                                const isCorrect = parseInt(hours) === problem.hour && parseInt(minutes) === problem.minute;
                                recordAttempt(1, 2, isCorrect);
                                if(isCorrect) {
                                   setTimeout(() => startMission(1, 2), 1600);
                                }
                            });
                        }
                    },
                    { 
                        instruction: "Encontramos o lanche do Dr. Desordem. Só podemos abrir a embalagem que está dentro da validade. Qual delas é?",
                        render: (container) => {
                            // CORREÇÃO: Atualiza o texto da instrução para este desafio.
                            container.parentElement.querySelector('#mission-instruction').textContent = missions[1].challenges[2].instruction;
                            const today = new Date();
                            const formatDate = (date) => `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear().toString().slice(-2)}`;
                            const items = [
                                { name: 'Suco de Uva', valid: true, date: `VAL: ${formatDate(new Date(today.getFullYear() + 1, getRandomInt(0, 11), getRandomInt(1, 28)))}` },
                                { name: 'Biscoito', valid: false, date: `VAL: ${formatDate(new Date(today.getFullYear() - 1, getRandomInt(0, 11), getRandomInt(1, 28)))}` },
                                { name: 'Iogurte', valid: false, date: `VAL: ${formatDate(new Date(today.getFullYear() - 2, getRandomInt(0, 11), getRandomInt(1, 28)))}` },
                            ].sort(() => Math.random() - 0.5);
                            container.innerHTML = `<div class="packaging-container"></div>`;
                            const pkgContainer = container.querySelector('.packaging-container');
                            items.forEach(item => {
                                const itemEl = document.createElement('div');
                                itemEl.className = 'packaging-item';
                                itemEl.innerHTML = `<h3>${item.name}</h3><p>${item.date}</p>`;
                                itemEl.addEventListener('click', () => {
                                    recordAttempt(1, 3, item.valid);
                                    if(item.valid) {
                                        showFeedback('Missão 1 completa!', true);
                                        setTimeout(() => showScreen('missions-screen'), 1600);
                                    }
                                });
                                pkgContainer.appendChild(itemEl);
                            });
                        }
                    }
                ]
            },
            2: {
                title: "Missão 2: Contabilizando as Provas",
                challenges: [
                    { 
                        instruction: "Agente, precisamos somar estas pistas. Resolva a operação:",
                        render: (container) => {
                            container.parentElement.querySelector('#mission-instruction').textContent = missions[2].challenges[0].instruction;
                            const problem = generateAdditionProblem();
                            container.innerHTML = `
                                <p style="font-size: 2rem; font-weight: bold;">${problem.num1} + ${problem.num2}</p>
                                <input type="number" id="math-answer" class="challenge-input" placeholder="Total">
                                <button id="check-math-btn" class="btn">Verificar</button>
                            `;
                            document.getElementById('check-math-btn').addEventListener('click', () => {
                                const answer = document.getElementById('math-answer').value;
                                const isCorrect = parseInt(answer) === problem.answer;
                                recordAttempt(2, 1, isCorrect);
                                if(isCorrect) setTimeout(() => startMission(2, 1), 1600);
                            });
                        }
                    },
                    { 
                        instruction: "Você precisa calcular os recursos restantes. Resolva a operação:",
                        render: (container) => {
                            container.parentElement.querySelector('#mission-instruction').textContent = missions[2].challenges[1].instruction;
                            const problem = generateSubtractionProblem();
                             container.innerHTML = `
                                <p style="font-size: 2rem; font-weight: bold;">${problem.num1} - ${problem.num2}</p>
                                <input type="number" id="math-answer" class="challenge-input" placeholder="Restante">
                                <button id="check-math-btn" class="btn">Verificar</button>
                            `;
                            document.getElementById('check-math-btn').addEventListener('click', () => {
                                const answer = document.getElementById('math-answer').value;
                                const isCorrect = parseInt(answer) === problem.answer;
                                recordAttempt(2, 2, isCorrect);
                                if(isCorrect) setTimeout(() => startMission(2, 2), 1600);
                            });
                        }
                    },
                     { 
                        instruction: "Resolva este problema para decifrar a pista final:",
                        render: (container) => {
                            container.parentElement.querySelector('#mission-instruction').textContent = missions[2].challenges[2].instruction;
                            const problemTemplates = [
                                { type: 'add', text: (n1, n2) => `O Dr. Desordem escondeu ${n1} diamantes e depois mais ${n2}. Quantos diamantes ele escondeu no total?`},
                                { type: 'sub', text: (n1, n2) => `A agente Ana tinha ${n1} dispositivos de espionagem, mas usou ${n2} na missão. Quantos restaram?`}
                            ];
                            const template = problemTemplates[getRandomInt(0, 1)];
                            const problem = template.type === 'add' ? generateAdditionProblem() : generateSubtractionProblem();
                            container.innerHTML = `
                                <p>${template.text(problem.num1, problem.num2)}</p>
                                <input type="number" id="math-answer" class="challenge-input" placeholder="Resposta">
                                <button id="check-math-btn" class="btn">Verificar</button>
                            `;
                            document.getElementById('check-math-btn').addEventListener('click', () => {
                                const answer = document.getElementById('math-answer').value;
                                const isCorrect = parseInt(answer) === problem.answer;
                                recordAttempt(2, 3, isCorrect);
                                if(isCorrect) {
                                    showFeedback('Missão 2 completa!', true);
                                    setTimeout(() => showScreen('missions-screen'), 1600);
                                }
                            });
                        }
                    }
                ]
            },
            3: {
                title: "Missão 3: O Cofre Geométrico",
                challenges: [
                    { 
                        instruction: "Para abrir a primeira trava, pressione os botões na sequência correta:",
                        render: (container) => {
                            const shapes = ['quadrado', 'círculo', 'triângulo', 'retângulo'];
                            const shapeMap = { 'quadrado': 'square', 'círculo': 'circle', 'triângulo': 'triangle', 'retângulo': 'rectangle'};
                            const shuffledShapes = [...shapes].sort(() => Math.random() - 0.5);
                            const correctSequence = shuffledShapes.map(s => shapeMap[s]);
                            container.parentElement.querySelector('#mission-instruction').textContent = `Para abrir a primeira trava, pressione os botões na sequência correta: ${shuffledShapes.join(', ')}.`;
                            let userSequence = [];
                            container.innerHTML = `
                                <div class="shape-container">
                                    <div class="shape-btn square" data-shape="square"></div>
                                    <div class="shape-btn circle" data-shape="circle"></div>
                                    <div class="shape-btn triangle" data-shape="triangle"></div>
                                    <div class="shape-btn rectangle" data-shape="rectangle"></div>
                                </div>
                                <p>Sequência clicada: <span id="sequence-display"></span></p>
                            `;
                            const shapeBtns = container.querySelectorAll('.shape-btn');
                            const sequenceDisplay = document.getElementById('sequence-display');
                            shapeBtns.forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const shape = btn.dataset.shape;
                                    userSequence.push(shape);
                                    sequenceDisplay.textContent = userSequence.map(s => Object.keys(shapeMap).find(key => shapeMap[key] === s)).join(', ');
                                    if(userSequence.length === correctSequence.length) {
                                        const isCorrect = JSON.stringify(userSequence) === JSON.stringify(correctSequence);
                                        recordAttempt(3, 1, isCorrect);
                                        userSequence = [];
                                        sequenceDisplay.textContent = '';
                                        if(isCorrect) setTimeout(() => startMission(3, 1), 1600);
                                    }
                                });
                            });
                        }
                    },
                    { 
                        instruction: "O computador descreve o cofre. Selecione o objeto correto.",
                        render: (container) => {
                            const spatialShapes = [
                                { name: 'cubo', desc: "É uma forma que tem 6 faces, todas iguais e quadradas.", svg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gradCube" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(255,255,0);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(255,165,0);stop-opacity:1" /></linearGradient></defs><path d="M50 15 L85 32.5 L85 67.5 L50 85 L15 67.5 L15 32.5 Z" fill="url(#gradCube)" stroke="#a07c00" stroke-width="2"/><path d="M50 15 L50 50 L15 32.5" fill="orange" stroke="#a07c00" stroke-width="1"/><path d="M50 50 L85 32.5" fill="yellow" stroke="#a07c00" stroke-width="1"/><path d="M50 50 L50 85" fill="gold" stroke="#a07c00" stroke-width="1"/></svg>` },
                                { name: 'esfera', desc: "É uma forma perfeitamente redonda, como uma bola.", svg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="gradSphere"><stop offset="10%" stop-color="white"/><stop offset="95%" stop-color="gold"/></radialGradient></defs><circle cx="50" cy="50" r="40" fill="url(#gradSphere)"/></svg>` },
                                { name: 'pirâmide', desc: "É uma forma com uma base quadrada e faces triangulares que se encontram em um ponto.", svg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gradPyramid" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(255,255,0);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(255,165,0);stop-opacity:1" /></linearGradient></defs><polygon points="15,85 50,15 85,85" fill="url(#gradPyramid)" stroke="#a07c00" stroke-width="2"/><polygon points="15,85 50,15 50,85" fill="orange" stroke="#a07c00" stroke-width="1"/></svg>`},
                                { name: 'cone', desc: "É uma forma com uma base circular e um vértice.", svg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gradCone" x1="50%" y1="0%" x2="50%" y2="100%"><stop offset="0%" stop-color="white"/><stop offset="100%" stop-color="gold"/></linearGradient></defs><ellipse cx="50" cy="85" rx="40" ry="10" fill="darkorange" /><path d="M10 85 A 40 10 0 0 0 90 85 L50 15 Z" fill="url(#gradCone)"/></svg>`}
                            ];
                            const shuffledOptions = [...spatialShapes].sort(() => Math.random() - 0.5);
                            const correctShape = spatialShapes[getRandomInt(0, spatialShapes.length - 1)];
                            container.parentElement.querySelector('#mission-instruction').textContent = `O computador descreve o cofre: '${correctShape.desc}' Selecione o objeto correto.`;
                            container.innerHTML = `<div class="spatial-shape-container"></div>`;
                            const shapeContainer = container.querySelector('.spatial-shape-container');
                            shuffledOptions.forEach(item => {
                                const itemEl = document.createElement('div');
                                itemEl.className = 'spatial-shape-item';
                                itemEl.dataset.shape = item.name;
                                itemEl.innerHTML = `${item.svg}<p>${item.name.charAt(0).toUpperCase() + item.name.slice(1)}</p>`;
                                shapeContainer.appendChild(itemEl);
                                itemEl.addEventListener('click', () => {
                                    const isCorrect = item.name === correctShape.name;
                                    recordAttempt(3, 2, isCorrect);
                                    if(isCorrect) {
                                        setTimeout(checkGameOver, 1600);
                                    }
                                });
                            });
                        }
                    }
                ]
            }
        };

        function startMission(missionId, challengeIndex = 0) {
            const mission = missions[missionId];
            if (!mission) return;
            const challenge = mission.challenges[challengeIndex];
            if(!challenge) {
                showScreen('missions-screen');
                return;
            }
            document.getElementById('mission-title').textContent = mission.title;
            const challengeArea = document.getElementById('challenge-area');
            challenge.render(challengeArea);
            showScreen('mission-content-screen');
        }

        function generateReportHTML() {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = ''; 
            const missionNames = { 1: "Missão 1: Tempo", 2: "Missão 2: Matemática", 3: "Missão 3: Geometria" };
            const challengeNames = {
                1: { 1: "Calendário", 2: "Relógio Digital", 3: "Validade" },
                2: { 1: "Adição", 2: "Subtração", 3: "Problema" },
                3: { 1: "Formas Planas", 2: "Formas Espaciais" }
            };
            let highlights = [];
            let toTrain = [];
            const missionsSection = document.createElement('div');
            missionsSection.className = 'report-section';
            missionsSection.innerHTML = '<h3>Status das Missões</h3>';
            for (const missionId in gameData.missions) {
                const mission = gameData.missions[missionId];
                const status = mission.completed ? '<span class="highlight">Completa</span>' : 'Incompleta';
                missionsSection.innerHTML += `<div class="report-item">${missionNames[missionId]}: ${status}</div>`;
            }
            reportContent.appendChild(missionsSection);
            const skillsSection = document.createElement('div');
            skillsSection.className = 'report-section';
            skillsSection.innerHTML = '<h3>Desempenho por Habilidade (1ª Tentativa)</h3>';
            for (const missionId in gameData.missions) {
                for (const challengeId in gameData.missions[missionId].challenges) {
                    const challenge = gameData.missions[missionId].challenges[challengeId];
                    const name = challengeNames[missionId][challengeId];
                    const { success, attempts } = challenge;
                    const result = attempts > 0 ? (success > 0 ? '<span class="highlight">Acertou</span>' : '<span class="to-train">Errou</span>') : 'Não tentou';
                    skillsSection.innerHTML += `<div class="report-item">${name}: ${result}</div>`;
                    if (attempts > 0) {
                        if (success > 0) highlights.push(name);
                        else toTrain.push(name);
                    }
                }
            }
            reportContent.appendChild(skillsSection);
            const summarySection = document.createElement('div');
            summarySection.className = 'report-section';
            summarySection.innerHTML = `
                <h3>Resumo do Agente</h3>
                <div class="report-item"><strong class="highlight">Habilidades de Destaque:</strong> ${highlights.length > 0 ? highlights.join(', ') : 'Nenhuma ainda.'}</div>
                <div class="report-item"><strong class="to-train">Pontos para Treinar:</strong> ${toTrain.length > 0 ? toTrain.join(', ') : 'Nenhum no momento.'}</div>
            `;
            reportContent.appendChild(summarySection);
        }

        // --- Event Listeners ---
        playerNameInput.addEventListener('input', () => {
            startGameBtn.disabled = playerNameInput.value.trim() === '';
        });

        startGameBtn.addEventListener('click', () => {
            playerName = playerNameInput.value.trim();
            if (playerName) {
                initializeGameData();
                updateMissionButtons();
                missionsHeader.textContent = `Quartel-General do Agente ${playerName}`;
                showScreen('missions-screen');
            }
        });

        backToMissionsBtn.addEventListener('click', () => {
            showScreen('missions-screen');
        });

        missionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.classList.contains('locked')) {
                    showFeedback('Complete a missão anterior primeiro!', false);
                    return;
                }
                const missionId = btn.dataset.mission;
                const missionData = gameData.missions[missionId];
                let firstIncomplete = 0;
                for (const challengeId in missionData.challenges) {
                    if (missionData.challenges[challengeId].success === 0) {
                        firstIncomplete = parseInt(challengeId) - 1;
                        break;
                    }
                }
                startMission(missionId, firstIncomplete);
            });
        });

        showReportBtn.addEventListener('click', () => {
            reportHeader.textContent = `Relatório do Agente ${playerName}`;
            reportSubheader.textContent = `Análise de desempenho na missão.`;
            generateReportHTML();
            showScreen('report-screen');
        });

        playAgainBtn.addEventListener('click', () => {
            playerNameInput.value = '';
            startGameBtn.disabled = true;
            showScreen('login-screen');
        });
        
        backToStartBtn.addEventListener('click', () => {
            playerNameInput.value = '';
            startGameBtn.disabled = true;
            showScreen('login-screen');
        });

    });
    </script>
</body>
</html>
